<!DOCTYPE html>
<html>
<head>
    <title>Private Chat with {{ other_user.username }}</title>
</head>
<body>

<h1>Chat with {{ other_user.username }}</h1>

<div id="messages">
    {% for msg in messages %}
        <p>
            <strong>{{ msg.sender.username }}</strong>:
            {{ msg.content }}
        </p>
    {% endfor %}
</div>

<input
    id="messageInput"
    type="text"
    placeholder="Type a message and press Enter"
/>

<script>
    // Username of the person we are chatting with
    const receiverUsername = "{{ other_user.username }}";

    // Open WebSocket connection
    const socket = new WebSocket(
        "ws://" + window.location.host + "/ws/dm/" + receiverUsername + "/"
    );

    // Confirm connection
    socket.onopen = function () {
        console.log("DM WebSocket connected");
    };

    // Receive messages from server
    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);

        const messagesDiv = document.getElementById("messages");
        const p = document.createElement("p");

        p.innerHTML = "<strong>" + data.sender + "</strong>: " + data.message;
        messagesDiv.appendChild(p);
    };

    // Send message on Enter
    document.getElementById("messageInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            const message = e.target.value.trim();
            if (!message) return;

            socket.send(JSON.stringify({
                message: message
            }));

            e.target.value = "";
        }
    });
</script>

</body>
</html>
